# Partner Module Implementation Plan

## 1. Database Schema Updates (Drizzle)

- [ ] **Create `src/db/schemas/partner/` directory**
- [ ] **Define `partners` table**:
    - `id` (UUID, PK)
    - `name` (text, not null)
    - `slug` (text, unique, for public page)
    - `description` (text)
    - `location` (text)
    - `contact_email` (text, for bill notifications)
    - `is_active` (boolean, default true)
    - `created_at`, `updated_at`
- [ ] **Update `auth.users` / `karate.members`**:
    - Add `partner_id` (UUID, FK to `partners.id`, nullable).
    - *Note*: This represents the "Venue" selected during onboarding.
- [ ] **Update `karate.courses`**:
    - Add `partner_id` (UUID, FK to `partners.id`, nullable).
    - *Logic*: If set, course is exclusive to that partner. If null, maybe available to all (or global).
- [ ] **Create `partner_bills` table** (Billing):
    - `id` (UUID)
    - `partner_id` (FK)
    - `course_id` (FK, optional, if bill is per course)
    - `month` / `year` (or `start_date`, `end_date`)
    - `amount` (integer, cents)
    - `status` (`pending`, `paid`)
    - `generated_at`

## 2. RBAC & Seeding

- [ ] **Update Enums/Types**:
    - Add `PARTNER` to `roletypeEnum` (or `roles` table content).
- [ ] **Update `scripts/seed-rbac.ts`**:
    - Ensure `PARTNER` role exists.
    - **Seed Default Partner**: Create "HSTU Campus" as the default partner in `partners` table.

## 3. Onboarding Flow Updates

- [ ] **Update Onboarding UI** (`src/app/(onboarding)/...`):
    - Fetch list of active Partners.
    - Add "Select Venue" dropdown (Default: "HSTU Campus").
- [ ] **Update Server Action** (`src/actions/check-profile.ts` or similar):
    - Accept `partner_id` in the payload.
    - Save `partner_id` to the `members` (or `account`) table.

## 4. Partner Profile Page (Public)

- [ ] **Create Page**: `src/app/partner/[slug]/page.tsx`
    - Fetch partner data by `slug`.
    - Display Name, Location, Description.
    - *Optional*: List courses available at this venue.

## 5. Partner Role & Dashboard

- [ ] **Middleware/RBAC**:
    - Allow users with `PARTNER` role to access `/dashboard/partner` (or shared dashboard with partner view).
- [ ] **Student Management**:
    - View list of students (`members` where `partner_id` = current partner's id).
    - "Add Student" feature: Create user/profile directly without standard full registration flow (simplified enrollment).

## 6. Course Enrollment & Scoping

- [ ] **Update Enrollment Logic**:
    - When a student tries to enroll:
        - Check Student's `partner_id`.
        - Check Course's `partner_id`.
        - **Rule**: If Course has `partner_id`, Student must match it. (Or Student can only see courses with their `partner_id`).
- [ ] **Billing View**:
    - **Student View**: If Student is under a Partner, show "Payment Status" based on whether the *Partner* has paid the bill for that month/course. "Managed by Partner".
    - **Partner View**: View Bills generated by Admin. Pay Bill (integrated payment gateway or manual mark as paid).

## 7. Admin Billing & Notifications

- [ ] **Admin Panel**:
    - Create "Generate Partner Bill" Interface.
    - Select Partner, Course (optional), Date Range, Amount.
    - Save to `partner_bills`.
- [ ] **Email Notification**:
    - Trigger email to `partner.contact_email` when bill is created.
    - Use `Resend` (existing setup).

## 8. Analysis & Verification

- [ ] Validate `users` vs `members` table for `partner_id` storage.
- [ ] Verify `check-profile.ts` logic for onboarding.
